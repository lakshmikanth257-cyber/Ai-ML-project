apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test-dependencies"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "asya-test-actors.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: alpine/k8s:1.28.3
    command:
      - /bin/sh
      - -c
      - |
        set -e
        echo "Testing dependencies for AsyncActor deployment..."
        echo ""

        # CRITICAL: Check AsyncActor CRD exists
        echo "Checking for AsyncActor CRD..."
        if ! kubectl get crd asyncactors.asya.sh >/dev/null 2>&1; then
          echo "[-] CRITICAL: AsyncActor CRD not found"
          echo ""
          echo "The AsyncActor CRD must be installed before deploying actors."
          echo "Install it with:"
          echo "  kubectl apply -f src/asya-operator/config/crd/"
          echo ""
          exit 1
        fi
        echo "[+] AsyncActor CRD exists (asyncactors.asya.sh)"

        # Check CRD version matches expected API version
        CRD_VERSION=$(kubectl get crd asyncactors.asya.sh -o jsonpath='{.spec.versions[?(@.storage==true)].name}')
        EXPECTED_VERSION="v1alpha1"
        if [ "$CRD_VERSION" != "$EXPECTED_VERSION" ]; then
          echo "[!] WARNING: CRD storage version is '$CRD_VERSION', expected '$EXPECTED_VERSION'"
          echo "  This may cause compatibility issues"
        else
          echo "[+] CRD version matches expected: $CRD_VERSION"
        fi
        echo ""

        {{- if and .Values.scaling .Values.scaling.enabled }}
        # CRITICAL: Check KEDA CRDs exist (required for autoscaling)
        echo "Checking for KEDA (scaling is enabled)..."
        if ! kubectl get crd scaledobjects.keda.sh >/dev/null 2>&1; then
          echo "[-] CRITICAL: KEDA ScaledObject CRD not found"
          echo ""
          echo "KEDA must be installed when scaling is enabled."
          echo "Install it with:"
          echo "  kubectl apply -f https://github.com/kedacore/keda/releases/download/v2.15.1/keda-2.15.1.yaml"
          echo "  OR"
          echo "  helm repo add kedacore https://kedacore.github.io/charts"
          echo "  helm install keda kedacore/keda --namespace keda-system --create-namespace"
          echo ""
          exit 1
        fi
        echo "[+] KEDA ScaledObject CRD exists"

        if ! kubectl get crd scaledjobs.keda.sh >/dev/null 2>&1; then
          echo "[!] WARNING: KEDA ScaledJob CRD not found (may be needed for certain scaling scenarios)"
        else
          echo "[+] KEDA ScaledJob CRD exists"
        fi
        echo ""
        {{- end }}

        # RECOMMENDED: Check if operator is running
        echo "Checking for Asya operator..."
        if kubectl get deployment asya-operator -n asya-system >/dev/null 2>&1; then
          READY=$(kubectl get deployment asya-operator -n asya-system -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
          DESIRED=$(kubectl get deployment asya-operator -n asya-system -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "1")
          if [ "$READY" = "$DESIRED" ] && [ "$READY" != "0" ]; then
            echo "[+] Operator is running and ready ($READY/$DESIRED replicas)"
          else
            echo "[!] WARNING: Operator exists but not ready ($READY/$DESIRED replicas)"
            echo "  The operator must be ready to reconcile AsyncActor resources"
          fi
        else
          echo "[!] WARNING: Operator deployment not found in asya-system namespace"
          echo "  Install it with:"
          echo "    helm install asya-operator deploy/helm-charts/asya-operator -n asya-system --create-namespace"
        fi
        echo ""

        {{- if eq .Values.transport "rabbitmq" }}
        # Transport configured: {{ .Values.transport }}
        echo "Transport is configured as: rabbitmq"
        echo "  Transport configuration is managed by the operator"
        echo ""
        {{- end }}

        echo "================================================"
        echo "[+] All critical dependency checks passed!"
        echo "================================================"
        echo ""
        echo "Ready to deploy AsyncActor '{{ .Values.name }}'"
        echo ""
