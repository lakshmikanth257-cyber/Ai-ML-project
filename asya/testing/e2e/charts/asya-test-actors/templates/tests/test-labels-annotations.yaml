apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test-labels-annotations"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "asya-test-actors.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: alpine/k8s:1.28.3
    command:
      - /bin/sh
      - -c
      - |
        set -e

        # Test a sample actor (echo) to validate labels and annotations
        TEST_ACTOR="test-echo"
        echo "Testing AsyncActor '$TEST_ACTOR' labels and annotations..."

        # Verify reserved labels are NOT on AsyncActor CR (operator adds them to child resources)
        APP_NAME=$(kubectl get asyncactor $TEST_ACTOR -n {{ .Release.Namespace }} -o jsonpath='{.metadata.labels.app\.kubernetes\.io/name}' || true)
        if [ -n "$APP_NAME" ]; then
          echo "[-] app.kubernetes.io/name label should NOT be on AsyncActor CR (reserved for operator use)"
          exit 1
        fi
        echo "[+] app.kubernetes.io/name label correctly absent from AsyncActor CR"

        # Check that only Helm-managed label is present (automatically added by Helm)
        MANAGED_BY=$(kubectl get asyncactor $TEST_ACTOR -n {{ .Release.Namespace }} -o jsonpath='{.metadata.labels.app\.kubernetes\.io/managed-by}')
        if [ "$MANAGED_BY" != "Helm" ]; then
          echo "[-] app.kubernetes.io/managed-by should be 'Helm', got '$MANAGED_BY'"
          exit 1
        fi
        echo "[+] app.kubernetes.io/managed-by label is correct: $MANAGED_BY"

        # Verify operator propagates labels to child resources (Deployment)
        DEPLOYMENT_APP_NAME=$(kubectl get deployment $TEST_ACTOR -n {{ .Release.Namespace }} -o jsonpath='{.metadata.labels.app\.kubernetes\.io/name}')
        if [ "$DEPLOYMENT_APP_NAME" != "$TEST_ACTOR" ]; then
          echo "[-] Deployment should have app.kubernetes.io/name='$TEST_ACTOR', got '$DEPLOYMENT_APP_NAME'"
          exit 1
        fi
        echo "[+] Operator correctly propagated labels to Deployment"

        echo ""
        echo "All label and annotation tests passed!"
